# 淺談單元測試 (Unit Testing)

## 什麼是單元測試

對程式中的最小可測試單元進行檢查與驗證。至於單元的意思，通常就要根據實際情況去判斷它具體的意義，像是在 C 語言中，單元指的是一個函數，在 Java 裡單元指的是一個類別，而在圖形化的軟體中，可以指的是一個視窗或一個選單等等。
總歸來說，單元就是人為規定的最小的被測試功能模組。單元測試是在軟體開發過程中要進行的最低層級的測試活動，軟體的獨立單元將在與程式的其他部分相隔離的情況下進行測試。

## 為何要寫單元測試

因為單元測試有幾個好處，所以才要單元測試：

- 因為在預期範疇內，可以隨時對程式碼進行任何更改。
- 單元測試可以有效降低程式出現錯誤的機率。
- 更深入地理解程式碼，寫單元測試的時候，需要明確地了解程式所有的執行流程及對應的執行結果。
- 允許在任何時候進行程式碼重構，而不必擔心破壞現有的程式碼。
- 確認程式碼的品質，因為單元測試時已經有驗證過程式碼的強度。
- 文件記錄，單元測試就是間接證明執行函數如何運用的的最佳佐證，與程式規格保持同步，也說明這份記錄是可被執行、可被正常編譯的。
- 避免改A壞B，自動化測試避免在修改程式碼的同時，破壞了其它程式執行的流程與邏輯，隨時可以進行測試以確保程式規格無誤。

## 何時寫單元測試

有三個時機點可以考慮撰寫單元測試：

- 測試驅動開發(TDD)所倡導的測試先行(Testing First)
- 開發當下同步施行單元測試，小量撰寫開發程式碼，然後撰寫大量單元測試驗證程式碼無虞，然後重複這 2個步驟直到開發完畢。好處是程式開發完畢，單元測試也幾乎完成。
- 開發程式完畢後再寫單元測試，但是這種測試的顆粒度就較粗，通常會用少量的測試案例去函括大多數的驗測邏輯，測試覆蓋的複雜度就會比較高。

## 單元測試要測到多精細

單元測試的重點在於提高覆蓋度，追求有效性，而非陷入提升單元測試案例數量的迷思。
有些情況就適合導入單元測試：

- 邏輯複雜度高
- 不易理解的，一段時間後就會忘記的，透過單元測試可以較快理解程式碼的流程與邏輯。
- 涉及核心業務，例：HTTP請求、攔截器(Interpreter)或共同工具(Utils)等。
- 涉及公共業務，產品核心業務通常需要的是最高標準的測試覆蓋率。

## 相關概念

### 待測系統 (SUT)

待测系统(System under test, SUT)，代表正在被驗測的系统, 目的是驗測系統可否正常運作，依據測試類型的不同，可指派的測試內容也不同，所以SUT可以小至一個類別或大至一個系統。

### 測試依賴組件 (DOC)

測試依賴組件(Dependency of component, DOC)，指的被待測系統依賴使用的組件，像是針對Service進行單元測試時所依賴的Dao組件就是DOC.

### 測試替身 (Test Doubles)

在單元測試時，會利用一些功能較為陽春並且行為與實際對象相似的虛擬對象作為SUT的依賴對象，以此降低單元測試的複雜性與提升可實現性。這些虛擬對象就是測試替身(Test Doubles)，有 5種類型：

- Test Stub

    當Test Stub的方法被SUT呼叫時，Test Stub要提供其間接輸入(Indirect Input)給SUT，故只要針對測試範圍與內容實作Test Stub即可，不用像正式實作程式給定完整的商業邏輯。

    在測試 Happy Path 時是比較容易的，要模擬硬體或交易逾時的情境就比較困難，Test Stub 就可以容易模擬這種情境，也可以讓 Test Stub 回傳固定的結果，例：模擬 UPS 物件可以回傳固定的電壓。

- Test Spy

    如果字面的意義，Spy (間諜)顧名思意就是用於蒐集重要物件的資訊，它是Test Stub 的一種變形，但除了與 Test Stub 一樣可以回應預期操作與資訊外，Test Spy 也記錄了方法被呼叫後的自身狀態的變化，可作為單元測試的「非直接輸入 (Indirect Input)」資訊的接受端，例：Audit Log。

    使用 Test Spy 的前提，要有記錄資訊的能力。

- Mock Object
